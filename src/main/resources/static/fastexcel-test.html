<!DOCTYPE html>
<html>
<head>
    <title>FastExcel Test</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .progress { margin: 10px 0; }
        .log { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: scroll; }
        button { padding: 8px 15px; margin: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ”¥ FastExcel í…ŒìŠ¤íŠ¸</h1>
    
    <div class="test-section">
        <h3>1. ë‹¨ì¼ ìš”ì²­ í…ŒìŠ¤íŠ¸</h3>
        <button onclick="testSingle()">FastExcel Single í…ŒìŠ¤íŠ¸</button>
        <div id="single-progress" class="progress"></div>
    </div>
    
    <div class="test-section">
        <h3>2. ì²­í¬ ë°©ì‹ í…ŒìŠ¤íŠ¸</h3>
        <button onclick="testChunked()">FastExcel Chunked í…ŒìŠ¤íŠ¸</button>
        <div id="chunked-progress" class="progress"></div>
    </div>
    
    <div class="test-section">
        <h3>3. ğŸ”¥ 3ê°œ ë™ì‹œ ìš”ì²­ í…ŒìŠ¤íŠ¸ (í•µì‹¬!)</h3>
        <button onclick="testConcurrent()">3ê°œ ë™ì‹œ í…ŒìŠ¤íŠ¸</button>
        <div id="concurrent-progress" class="progress"></div>
    </div>
    
    <div class="test-section">
        <h3>ì‹¤ì‹œê°„ ë¡œê·¸</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <script>
        const log = document.getElementById('log');
        
        function addLog(message) {
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `[${time}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            log.innerHTML = '';
        }
        
        function connectWebSocket(sessionId, progressElementId) {
            const ws = new WebSocket(`ws://localhost:8080/ws/download-progress?sessionId=${sessionId}`);
            
            ws.onopen = function() {
                addLog(`WebSocket ì—°ê²°: ${sessionId}`);
            };
            
            ws.onmessage = function(event) {
                const progress = JSON.parse(event.data);
                const progressElement = document.getElementById(progressElementId);
                
                if (progress.status === 'PROCESSING') {
                    const percent = progress.progressPercentage || 0;
                    progressElement.innerHTML = `ì§„í–‰ë¥ : ${percent}% (${progress.processedCount}ê±´ ì²˜ë¦¬)`;
                    addLog(`${sessionId}: ${percent}% ì™„ë£Œ`);
                } else if (progress.status === 'COMPLETED') {
                    progressElement.innerHTML = `âœ… ì™„ë£Œ! <a href="${progress.downloadUrl}" target="_blank">ë‹¤ìš´ë¡œë“œ</a>`;
                    addLog(`${sessionId}: ì™„ë£Œ! ${progress.downloadUrl}`);
                } else if (progress.status === 'FAILED') {
                    progressElement.innerHTML = `âŒ ì‹¤íŒ¨: ${progress.message}`;
                    addLog(`${sessionId}: ì‹¤íŒ¨ - ${progress.message}`);
                } else {
                    progressElement.innerHTML = `ìƒíƒœ: ${progress.status}`;
                    addLog(`${sessionId}: ${progress.status}`);
                }
            };
            
            ws.onerror = function(error) {
                addLog(`WebSocket ì˜¤ë¥˜: ${sessionId} - ${error}`);
            };
            
            ws.onclose = function() {
                addLog(`WebSocket ì—°ê²° ì¢…ë£Œ: ${sessionId}`);
            };
            
            return ws;
        }
        
        async function testSingle() {
            addLog('ğŸš€ FastExcel Single í…ŒìŠ¤íŠ¸ ì‹œì‘');
            const sessionId = 'fastexcel-single-test';
            
            // WebSocket ì—°ê²°
            connectWebSocket(sessionId, 'single-progress');
            
            // API í˜¸ì¶œ
            try {
                const response = await fetch('/api/fastexcel/single', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                });
                
                const result = await response.json();
                addLog(`API ì‘ë‹µ: ${result.message}`);
                
            } catch (error) {
                addLog(`API ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function testChunked() {
            addLog('ğŸš€ FastExcel Chunked í…ŒìŠ¤íŠ¸ ì‹œì‘');
            const sessionId = 'fastexcel-chunked-test';
            
            connectWebSocket(sessionId, 'chunked-progress');
            
            try {
                const response = await fetch('/api/fastexcel/chunked', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                });
                
                const result = await response.json();
                addLog(`API ì‘ë‹µ: ${result.message}`);
                
            } catch (error) {
                addLog(`API ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function testConcurrent() {
            addLog('ğŸ”¥ 3ê°œ ë™ì‹œ í…ŒìŠ¤íŠ¸ ì‹œì‘!!!');
            
            // ê°ê° WebSocket ì—°ê²°
            connectWebSocket('concurrent-test-1', 'concurrent-progress');
            connectWebSocket('concurrent-test-2', 'concurrent-progress');
            connectWebSocket('concurrent-test-3', 'concurrent-progress');
            
            try {
                const response = await fetch('/api/fastexcel/concurrent-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                addLog(`ë™ì‹œ í…ŒìŠ¤íŠ¸ API ì‘ë‹µ: ${result.message}`);
                document.getElementById('concurrent-progress').innerHTML = '3ê°œ ìš”ì²­ ëª¨ë‘ ì‹œì‘ë¨. ë¡œê·¸ì—ì„œ ì§„í–‰ë¥  í™•ì¸í•˜ì„¸ìš”.';
                
            } catch (error) {
                addLog(`ë™ì‹œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`);
            }
        }
    </script>
</body>
</html>
